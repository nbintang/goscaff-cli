package main

import (
	"fmt" 
	"{{.MODULE_PATH}}/internal/user" 

	"strings"

	"github.com/go-faker/faker/v4"
	"github.com/gosimple/slug"
	"gorm.io/gorm"
	"gorm.io/gorm/clause"
)

type Options struct {
	Count int
}

func InitSeeds(db *gorm.DB, opt Options) error {
	domain := strings.TrimPrefix("example.com", "@")

	if err := db.Exec("TRUNCATE TABLE users RESTART IDENTITY CASCADE").Error; err != nil {
		return err
	}

	for i := 0; i < opt.Count; i++ {
		name := faker.Name()

		u := user.User{
			Name:  name,
			Email: fmt.Sprintf("%s.%d@%s", slug.Make(name), i+1, domain),
		}

		if err := db.Clauses(clause.OnConflict{
            Columns: []clause.Column{
                {Name: "email"},
            },
			DoNothing: true,
		}).Create(&u).Error; err != nil {
			return fmt.Errorf("create user failed (%s): %w", name, err)
		}
	}

	fmt.Println("Seeds initialized successfully")
	return nil
}
